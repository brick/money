<?php

/**
 * Currency symbols.
 *
 * @see http://www.xe.com/symbols.php
 * @see http://en.wikipedia.org/wiki/ISO_4217
 */
$symbols = [
    'AED' => 'د.إ',
    'AFN' => 'Af',
    'ALL' => 'Lek',
    'AMD' => "\xd6\x8f",
    'ANG' => 'ƒ',
    'AOA' => 'Kz',
    'ARS' => '$',
    'AUD' => '$',
    'AWG' => 'Afl.',
    'AZN' => 'ман',
    'BAM' => 'KM',
    'BBD' => 'Bds$',
    'BDT' => "\xe0\xa7\xb3",
    'BGN' => 'лв',
    'BHD' => '.د.ب',
    'BIF' => 'FBu',
    'BMD' => 'BD$',
    'BND' => 'B$',
    'BOB' => 'Bs.',
    'BOV' => 'BOV',
    'BRL' => 'R$',
    'BSD' => 'B$',
    'BTN' => 'Nu.',
    'BWP' => 'P',
    'BYR' => 'Br',
    'BZD' => 'BZ$',
    'CAD' => '$',
    'CDF' => 'FC',
    'CHE' => 'CHE',
    'CHF' => 'CHF',
    'CHW' => 'CHW',
    'CLF' => 'CLF',
    'CLP' => '$',
    'CNY' => '¥',
    'COP' => '$',
    'COU' => 'COU',
    'CRC' => '₡',
    'CUC' => '$',
    'CUP' => '$',
    'CVE' => '$',
    'CZK' => 'Kč',
    'DJF' => 'Fdj',
    'DKK' => 'kr.',
    'DOP' => '$',
    'DZD' => 'دج',
    'EGP' => 'ج.م',
    'ERN' => 'Nfk',
    'ETB' => 'Br',
    'EUR' => '€',
    'FJD' => 'FJ$',
    'FKP' => '£',
    'GBP' => '£',
    'GEL' => 'ლ',
    'GHS' => 'GH₵',
    'GIP' => '£',
    'GMD' => 'D',
    'GNF' => 'FG',
    'GTQ' => 'Q',
    'GYD' => '$',
    'HKD' => '$',
    'HNL' => 'L',
    'HRK' => 'kn',
    'HTG' => 'G',
    'HUF' => 'Ft',
    'IDR' => 'Rp',
    'ILS' => '₪',
    'INR' => "\xe2\x82\xb9",
    'IQD' => 'ع.د',
    'IRR' => "\xef\xb7\xbc",
    'ISK' => 'kr',
    'JMD' => '$',
    'JOD' => 'ينار',
    'JPY' => '¥',
    'KES' => 'KSh',
    'KGS' => 'сом',
    'KHR' => "\xe1\x9f\x9b",
    'KMF' => 'CF',
    'KPW' => '₩',
    'KRW' => '₩',
    'KWD' => 'د.ك',
    'KYD' => '$',
    'KZT' => "\xe2\x82\xb8",
    'LAK' => '₭',
    'LBP' => 'ل.ل',
    'LKR' => '₨',
    'LRD' => 'L$',
    'LSL' => 'L',
    'LTL' => 'Lt',
    'LVL' => 'Ls',
    'LYD' => 'ل.د',
    'MAD' => 'د.م.',
    'MDL' => 'L',
    'MGA' => 'Ar',
    'MKD' => 'ден',
    'MMK' => 'K',
    'MNT' => '₮',
    'MOP' => 'MOP$',
    'MRO' => 'UM',
    'MUR' => '₨',
    'MVR' => 'Rf',
    'MWK' => 'MK',
    'MXN' => '$',
    'MXV' => 'MXV',
    'MYR' => 'RM',
    'MZN' => 'MT',
    'NAD' => '$',
    'NGN' => '₦',
    'NIO' => 'C$',
    'NOK' => 'kr',
    'NPR' => '₨',
    'NZD' => '$',
    'OMR' => '﷼',
    'PAB' => 'B/.',
    'PEN' => 'S/.',
    'PGK' => 'K',
    'PHP' => '₱',
    'PKR' => '₨',
    'PLN' => 'zł',
    'PYG' => 'Gs',
    'QAR' => '﷼',
    'RON' => 'lei',
    'RSD' => 'Дин.',
    'RUB' => 'руб',
    'RWF' => 'FRw',
    'SAR' => '﷼',
    'SBD' => '$',
    'SCR' => '₨',
    'SDG' => 'SDG',
    'SEK' => 'kr',
    'SGD' => '$',
    'SHP' => '£',
    'SLL' => 'Le',
    'SOS' => 'S',
    'SRD' => '$',
    'SSP' => 'SSP',
    'STD' => 'Db',
    'SVC' => '₡',
    'SYP' => '£',
    'SZL' => 'L',
    'THB' => '฿',
    'TJS' => 'TJS',
    'TMT' => 'T',
    'TND' => 'د.ت',
    'TOP' => 'T$',
    'TRY' => "\xe2\x82\xba",
    'TTD' => 'TT$',
    'TWD' => 'NT$',
    'TZS' => 'TZS',
    'UAH' => '₴',
    'UGX' => 'USh',
    'USD' => '$',
    'USN' => 'USN',
    'USS' => 'USS',
    'UYI' => 'UYI',
    'UYU' => '$U',
    'UZS' => 'лв',
    'VEF' => 'Bs',
    'VND' => '₫',
    'VUV' => 'VT',
    'WST' => 'WS$',
    'XAF' => 'FCFA',
    'XAG' => 'XAG',
    'XAU' => 'XAU',
    'XBA' => 'XBA',
    'XBB' => 'XBB',
    'XBC' => 'XBC',
    'XBD' => 'XBD',
    'XCD' => '$',
    'XDR' => 'XDR',
    'XFU' => 'XFU',
    'XOF' => 'CFA',
    'XPD' => 'XPD',
    'XPF' => 'F',
    'XPT' => 'XPT',
    'XSU' => 'XSU',
    'XTS' => 'XTS',
    'XUA' => 'XUA',
    'XXX' => 'XXX',
    'YER' => '﷼',
    'ZAR' => 'R',
    'ZMW' => 'ZK',
    'ZWL' => '$',
];

$data = file_get_contents('http://www.currency-iso.org/dam/downloads/table_a1.xml');

$document = new DOMDocument();
$document->loadXML($data);

$countries = $document->getElementsByTagName('CcyNtry');
$result = [];

foreach ($countries as $country) {
    /** @var DOMElement $country */
    $name = getDomElementString($country, 'CcyNm');
    $currencyCode = getDomElementString($country, 'Ccy');
    $numericCode = getDomElementString($country, 'CcyNbr');
    $minorUnit = getDomElementString($country, 'CcyMnrUnts');

    if ($name === null || $currencyCode === null && $numericCode === null && $minorUnit == null) {
        continue;
    }

    $name = checkName($name);
    $currencyCode = checkCurrencyCode($currencyCode);
    $numericCode = checkNumericCode($numericCode);
    $minorUnit = checkMinorUnit($minorUnit);

    if (isset($symbols[$currencyCode])) {
        $symbol = $symbols[$currencyCode];
    } else {
        die("Missing symbol for $currencyCode");
    }

    $value = [$currencyCode, $numericCode, $name, $symbol, $minorUnit];

    if (isset($result[$currencyCode])) {
        if ($result[$currencyCode] !== $value) {
            throw new \RuntimeException('Inconsistent values found for currency code ' . $currencyCode);
        }
    }

    $result[$currencyCode] = [$currencyCode, $numericCode, $name, $symbol, $minorUnit];
}

exportToFile('data/currencies.php', $result);

printf('Exported %d currencies.' . PHP_EOL, count($result));

/**
 * @param string $file
 * @param mixed  $data
 *
 * @return void
 */
function exportToFile($file, $data)
{
    file_put_contents($file, sprintf("<?php return %s;\n", var_export($data, true)));
}

/**
 * @param DOMElement $element
 * @param string     $name
 *
 * @return string|null
 */
function getDomElementString(DOMElement $element, $name)
{
    foreach ($element->getElementsByTagName($name) as $child) {
        /** @var $child DOMElement */
        return $child->textContent;
    }

    return null;
}

/**
 * @param string $name
 * @return string
 * @throws RuntimeException
 */
function checkName($name)
{
    if ($name == '' || ! mb_check_encoding($name, 'UTF-8')) {
        throw new \RuntimeException('Invalid currency name: ' . $name);
    }

    return $name;
}

/**
 * @param string $currencyCode
 * @return string
 * @throws RuntimeException
 */
function checkCurrencyCode($currencyCode)
{
    if (preg_match('/^[A-Z]{3}$/', $currencyCode) == 0) {
        throw new \RuntimeException('Invalid currency code: ' . $currencyCode);
    }

    return $currencyCode;
}

/**
 * @param string $numericCode
 * @return int
 * @throws RuntimeException
 */
function checkNumericCode($numericCode)
{
    if ($numericCode == 'Nil') {
        return 0;
    }

    if (preg_match('/^[0-9]{3}$/', $numericCode) == 0) {
        throw new \RuntimeException('Invalid numeric code: ' . $numericCode);
    }

    return (int) $numericCode;
}

/**
 * @param string $minorUnit
 * @return int
 * @throws RuntimeException
 */
function checkMinorUnit($minorUnit)
{
    if ($minorUnit == 'N.A.') {
        return -1;
    }

    if (preg_match('/^[0-9]{1}$/', $minorUnit) == 0) {
        throw new \RuntimeException('Invalid minor unit: ' . $minorUnit);
    }

    return (int) $minorUnit;
}
